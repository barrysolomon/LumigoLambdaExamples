
Disclaimer: This and the other READEMEs were generated by chatGPT.  They look correct, but I have not followed their steps from scratch.

---

# Lambda Functions with Lumigo Tracing

This guide covers building and deploying two AWS Lambda functions with npm dependencies, specifically the Lumigo tracer, and configuring an EventBridge rule to connect them.

## Step 1: Set Up Your Environment

1. **Install Node.js**: Ensure that Node.js and npm are installed on your system.
2. **Install AWS CLI**: Ensure the AWS CLI is installed and configured:
   ```bash
   aws configure
   ```

3. **Create Project Structure**: Set up a folder structure.
   ```bash
   mkdir lambda-project
   cd lambda-project
   mkdir logAndTriggerLambda triggeredLambda
   ```

## Step 2: Initialize and Install Dependencies

1. **Initialize Node.js Project**:
   Inside each Lambda’s directory (`logAndTriggerLambda` and `triggeredLambda`), run:
   ```bash
   npm init -y
   ```

2. **Install Lumigo Tracer**:
   In each Lambda folder, install Lumigo as a dependency:
   ```bash
   npm install @lumigo/tracer
   ```

## Step 3: Add Lambda Code

1. **Copy the Code**:
   Save the `logAndTriggerLambda.js` and `triggeredLambda.js` files with the provided code in their respective folders (`logAndTriggerLambda` and `triggeredLambda`).

## Step 4: Create a Deployment Package

1. **Zip Each Lambda with Dependencies**:
   Each Lambda’s folder must include its `node_modules` folder, so zip each directory’s contents to create a deployment package:

   ```bash
   cd logAndTriggerLambda
   zip -r ../logAndTriggerLambda.zip .
   cd ../triggeredLambda
   zip -r ../triggeredLambda.zip .
   cd ..
   ```

## Step 5: Deploy the Lambda Functions

1. **Create the First Lambda Function (`logAndTriggerLambda`)**:
   Use the following command, replacing `LOG_AND_TRIGGER_ROLE_ARN` with the ARN of the IAM role created for this Lambda.

   ```bash
   aws lambda create-function --function-name logAndTriggerLambda \
       --runtime nodejs18.x \
       --role LOG_AND_TRIGGER_ROLE_ARN \
       --handler logAndTriggerLambda.handler \
       --zip-file fileb://logAndTriggerLambda.zip \
       --environment Variables="{TRACE_SAMPLING_RATE=1.0}"
   ```

2. **Create the Second Lambda Function (`triggeredLambda`)**:

   ```bash
   aws lambda create-function --function-name triggeredLambda \
       --runtime nodejs18.x \
       --role TRIGGERED_LAMBDA_ROLE_ARN \
       --handler triggeredLambda.handler \
       --zip-file fileb://triggeredLambda.zip \
       --environment Variables="{TRACE_SAMPLING_RATE=1.0}"
   ```

## Step 6: Configure EventBridge Rule to Trigger the Second Lambda

If the `TriggerSecondLambdaRule` rule isn’t present or if you encounter any issues, follow these steps to create the rule and connect it to `triggeredLambda`.

1. **Create the EventBridge Rule**:

   ```bash
   aws events put-rule --name TriggerSecondLambdaRule \
       --event-pattern '{"source": ["custom.myapp"], "detail-type": ["MyAppEvent"]}'
   ```

2. **Add `triggeredLambda` as a Target for the Rule**:

   ```bash
   aws events put-targets --rule TriggerSecondLambdaRule \
       --targets "Id"="1","Arn"="arn:aws:lambda:YOUR_REGION:YOUR_ACCOUNT_ID:function:triggeredLambda"
   ```

   Replace:
   - `YOUR_REGION` with your AWS region (e.g., `us-east-1`).
   - `YOUR_ACCOUNT_ID` with your AWS account ID.

3. **Grant EventBridge Permission to Invoke `triggeredLambda`**:

   After creating the rule and adding the target, add permission for EventBridge to invoke `triggeredLambda`:

   ```bash
   aws lambda add-permission --function-name triggeredLambda \
       --statement-id AllowEventBridgeInvoke \
       --action "lambda:InvokeFunction" \
       --principal events.amazonaws.com \
       --source-arn arn:aws:events:YOUR_REGION:YOUR_ACCOUNT_ID:rule/TriggerSecondLambdaRule
   ```

### Verify EventBridge Rule and Target

To ensure the configuration is correct:
1. Go to **Amazon EventBridge** > **Rules** in the AWS Console, and confirm `TriggerSecondLambdaRule` is listed and enabled.
2. Check the **Targets** section within the rule to ensure `triggeredLambda` is listed.

## Step 7: Test the Lambda Functions

1. **Invoke `logAndTriggerLambda` Directly**:

   ```bash
   aws lambda invoke --function-name logAndTriggerLambda response.json
   ```

2. **Verify**:
   Check **CloudWatch Logs** to see if `logAndTriggerLambda` logged its message and sent an event to EventBridge, which should then trigger `triggeredLambda`.

## Step 8: Update Lambda Functions (For Future Changes)

If you modify the code, re-zip the relevant folder and update the Lambda function:

```bash
aws lambda update-function-code --function-name logAndTriggerLambda --zip-file fileb://logAndTriggerLambda.zip
aws lambda update-function-code --function-name triggeredLambda --zip-file fileb://triggeredLambda.zip
```

## Additional Notes

- **IAM Roles**: Ensure each Lambda function has a role with permissions for Lambda execution, EventBridge (for the first Lambda), and logging to CloudWatch.
- **Monitoring**: Optionally, configure monitoring in AWS Console or with Lumigo for better observability.

This setup deploys both Lambdas with npm dependencies, Lumigo tracing, and connectivity via EventBridge.